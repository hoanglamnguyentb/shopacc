@model Hinet.Web.Models.GameVM.DanhMucGameVM
@using CommonHelper.Number

@{
    var game = Model.Game;
    var danhMuc = Model.DanhMucGame;
    var taiKhoanPagedResult = Model.TaiKhoanPagedResult;
}

<div class="container c-container" id="account-list">
    <ul class="breadcrumb-list">
        <li class="breadcrumb-item">
            <a href="/" class="breadcrumb-link">Trang chủ</a>
        </li>
        <li class="breadcrumb-item">
            <a href="/game/@game.Slug" class="breadcrumb-link">@game.Name</a>
        </li>
        <li class="breadcrumb-item">
            <a href="javascript:void(0)" class="breadcrumb-link">@danhMuc.Name</a>
        </li>
    </ul>
    <div class="head-mobile">
        <a href="/mua-acc" class="link-back"></a>
        <p class="head-title text-title">@game.Name</p>
        <a href="/viewed">
            <img src="/assets/frontend/theme_5/image/DA-XEM.png" alt="" style="position: absolute;top: 16px;right: 16px;width:30px; height: 30px">
        </a>
    </div>

    <div class="banner-slide swiper-general c-mt-2">
        <div class="swiper swiper-banner brs-12 swiper-container-horizontal" style="cursor: grab;">
            <div class="swiper-wrapper" style="transition-duration: 0ms;">
            </div>

            <div class="navigation slider-next "></div>
            <div class="navigation slider-prev "></div>
        </div>
        <div class="swiper-pagination swiper-pagination-clickable swiper-pagination-bullets"></div>
    </div>
    <div class="booking_detail"></div>

    <section class="list-account" style="margin-top: 2px">
        <div class="section-header justify-content-between  d-none d-lg-flex c-py-16">
            <h1 class="section-title">@danhMuc.Name </h1>
        </div>
        <div class="filter-account c-my-16 d-none d-lg-flex">
            <div class="filter-title text-title fw-700">
                Chọn game muốn mua account
            </div>
            <div class="value-filter">
                <div class="nick-findter-data" id="params-filter"></div>
                <div class="show-modal-filter noselect" data-toggle="modal" data-target="#modal-filter">
                    Tìm kiếm
                </div>
            </div>
        </div>

        <div class="list-related-tag-home">
        </div>

        <div class="sort-account c-mb-16 d-none d-lg-flex">
            <div class="text-title fw-700" id="numberResult">@taiKhoanPagedResult.Count sản phẩm</div>
            <div class="value-sort d-flex align-items-center">
                <div class="text-title fw-700 c-mr-16">
                    Sắp xếp theo:
                </div>
                <div>
                    <a href="#" class="selection active md" data-sort="random">Ngẫu nhiên</a>
                    <a href="#" class="selection md" data-sort="price_start">Giá từ cao đến thấp</a>
                    <a href="#" class="selection md" data-sort="price_end">Giá từ thấp đến cao</a>
                    <a href="#" class="selection md" data-sort="created_at_start">Mới nhất</a>
                    <a href="#" class="selection md" data-sort="created_at_end">Cũ nhất</a>
                </div>
            </div>
        </div>
        <!-- Mobile -->
        <div class="text-title fw-700 c-mb-8 d-lg-none">
            @danhMuc.Name
        </div>
        <div id="account-list-container">
            @Html.Partial("_TaiKhoanList", Model.TaiKhoanPagedResult, new ViewDataDictionary {
                { "DanhMuc", danhMuc },
                { "Game", game },

            })
        </div>
    </section>
    <!-- Modal Filter -->
    <div class="modal fade" id="modal-filter">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <form action="" class="form-filter">
                    <div class="modal-header">
                        <p class="modal-title center">Tìm kiếm</p>
                        <button type="button" class="close" data-dismiss="modal"></button>
                    </div>
                    <div class="modal-body p-0">
                        <div class="input-group">
                            <span class="form-label">
                                Tìm kiếm
                            </span>
                            <input type="text" class="find" name="find" placeholder="Nhập skin,tên tướng,level...">
                        </div>
                        <div class="input-group">
                            <label class="form-label">
                                Mã số
                            </label>
                            <input type="text" class="input-defautf-ct id" name="id_data" placeholder="Nhập mã số nick">
                        </div>

                        <div class="input-group">
                            <label class="form-label">
                                Giá tiền
                            </label>
                            <select name="price_data" class="price">
                                <option value="" selected="">Chọn giá tiền</option>
                                <option value="0-50000">Dưới 50K</option>
                                <option value="50000-200000">Từ 50K - 200K</option>
                                <option value="200000-500000">Từ 200K - 500K</option>
                                <option value="500000-1000000">Từ 500K - 1 Triệu</option>
                                <option value="1000000-5000000">Trên 1 Triệu</option>
                                <option value="5000000-10000000">Trên 5 Triệu</option>
                                <option value="10000000">Trên 10 Triệu</option>
                            </select>
                        </div>

                        <div class="input-group">
                            <label class="form-label">
                                Trạng thái
                            </label>
                            <select name="status_data" class="" id="">
                                <option value="" selected="">Chọn trạng thái</option>
                                <option value="1">Chưa bán</option>
                                <option value="2">Đã bán</option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer c-mt-24 c-mt-lg-16">
                        <a href="javascript:void(0)" class="btn ghost js-reset-form">Xoá tìm kiếm</a>
                        <button type="submit" class="btn primary js-submit-form">Xem kết quả</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Start Danh mục game khác -->
    @Html.Action("DanhMucGameKhac", "Game", new { id = danhMuc.Id, area = "" })
    <!-- End Danh mục game khác -->
</div>

<!-- Form filter + sort gom chung -->
<form id="form-filter">
    <input type="hidden" name="Slug" value="@danhMuc.Slug" />
    <input type="hidden" name="sortQuery" value="random" />
    <!-- Filter fields -->
    <input type="hidden" name="UserNameFilter" value="" />
    <input type="hidden" name="CodeFilter" value="" />
    <input type="hidden" name="TrangThaiFilter" value="" />
    <input type="hidden" name="GiaMin" value="" />
    <input type="hidden" name="GiaMax" value="" />
</form>


<script>
// Hàm dùng chung
function loadTaiKhoan(page) {
    var slug = '@danhMuc.Slug';
    var formData = $("#form-filter").serializeArray(); // gom filter + sort

    var data = { slug: slug, page: page };
    $.each(formData, function (i, field) {
        data[field.name] = field.value;
    });

    $.ajax({
        url: "/Game/LoadTaiKhoan",
        type: "GET",
        data: data,
        success: function (res) {
            $("#account-list-container").html(res);
            $('html, body').animate({ scrollTop: 0 }, 200);
        }
    });
}

// Phân trang
$(document).on("click", ".js-change-page", function (e) {
    e.preventDefault();
    var page = $(this).data("page");
    if (!page || $(this).parent().hasClass("disabled") || $(this).parent().hasClass("active")) return;
    loadTaiKhoan(page);
});

// Sort
$(document).on("click", ".selection", function (e) {
    e.preventDefault();
    $(".selection").removeClass("active");
    $(this).addClass("active");
    $("input[name='sortQuery']").val($(this).data("sort"));
    loadTaiKhoan(1);
});

// Filter
$(document).on("submit", "#form-filter", function (e) {
    e.preventDefault();
    loadTaiKhoan(1);
});

// Khi submit filter trong modal hoặc sheet
$(document).on("submit", ".form-filter", function (e) {
    e.preventDefault();

    // Lấy dữ liệu filter từ modal/sheet
    var find = $(this).find("input[name='find']").val();
    var code = $(this).find("input[name='id_data']").val();
    var status = $(this).find("select[name='status_data']").val();
    var price = $(this).find("select[name='price_data']").val(); // ví dụ "200000-500000"
    console.log("price", price)

    // Map sang hidden trong #form-filter
    $("#form-filter input[name='UserNameFilter']").val(find);
    $("#form-filter input[name='CodeFilter']").val(code);
    $("#form-filter input[name='TrangThaiFilter']").val(status);

    if (price) {
        var parts = price.split("-");
        $("#form-filter input[name='GiaMin']").val(parts[0] || "");
        $("#form-filter input[name='GiaMax']").val(parts[1] || "");
    } else {
        $("#form-filter input[name='GiaMin']").val("");
        $("#form-filter input[name='GiaMax']").val("");
    }

    // Gọi load Ajax
    loadTaiKhoan(1);

    // Đóng modal/sheet
    $("#modal-filter").modal("hide");
    $("#sheet-filter").attr("aria-hidden", "true");
});

$(document).on("click", ".js-reset-form", function (e) {
    e.preventDefault();

    // Reset các field trong form filter (modal/sheet)
    var $form = $(this).closest("form");
    $form.find("input[type=text], select").val("");

    // Reset hidden trong #form-filter
    $("#form-filter input[name='UserNameFilter']").val("");
    $("#form-filter input[name='CodeFilter']").val("");
    $("#form-filter input[name='TrangThaiFilter']").val("");
    $("#form-filter input[name='GiaMin']").val("");
    $("#form-filter input[name='GiaMax']").val("");

    // Load lại dữ liệu ban đầu
    loadTaiKhoan(1);

    // Đóng modal/sheet nếu có
    $("#modal-filter").modal("hide");
    $("#sheet-filter").attr("aria-hidden", "true");
});
</script>
