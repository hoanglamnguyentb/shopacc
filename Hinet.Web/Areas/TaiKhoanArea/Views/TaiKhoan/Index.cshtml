@using Hinet.Model.IdentityEntities;
@using Hinet.Model.Entities;
@using Newtonsoft.Json;
@using Hinet.Service.Common;
@using Hinet.Service.TaiKhoanService.Dto;
@model PageListResultBO<TaiKhoanDto>
@{
    var game = ViewBag.Game as Game;
    ViewBag.Title = "";
    Layout = "~/Views/Shared/_LayoutAce.cshtml";
    ViewBag.ModuleName = "Quản lý tài khoản";
    ViewBag.PageName = game == null
        ? "Danh sách tài khoản game"
        : "Danh sách tài khoản game " + game.Name;

    ViewBag.ModuleCode = "TaiKhoan_index";
    var dropdownListGameId = ViewBag.dropdownListGameId as List<SelectListItem>;
    var lstData = Html.Raw(JsonConvert.SerializeObject(Model.ListItem));
    var createUrl = "/TaiKhoanArea/TaiKhoan/Create" + (game != null ? "/" + game.Id : "");
}

<link href="https://unpkg.com/dropzone@5/dist/min/dropzone.min.css" rel="stylesheet" />
<script src="https://unpkg.com/dropzone@5/dist/min/dropzone.min.js"></script>

@section ActionBarRight{
    <a href="#collapseDiv" class="btn btn-sm btn-primary" aria-controls="collapsePanel" data-toggle="collapse" role="button">
        <i class="bi bi-search"></i> Tìm kiếm
    </a>
    <a href="javascript:void(0)"  onclick="CreateAction('@createUrl')"  class="btn btn-primary btn-sm"><i class="bi bi-plus-lg"></i> Thêm mới</a>
}
@Html.Partial("_SearchPartial")

<div class="tabbable">
    <ul class="nav nav-tabs">
        <li class="nav-item @(game == null ? "active" : "")">
            <a class="nav-link" href="/TaiKhoanArea/TaiKhoan">Tất cả</a>
        </li>
        @foreach (var item in dropdownListGameId)
        {
            <li class="nav-item @(game != null && game.Id.ToString() == item.Value ? "active" : "")">
                <a class="nav-link" href="/TaiKhoanArea/TaiKhoan/Index/@item.Value">@item.Text</a>
            </li>
        }
    </ul>
    <div class="tab-content">
        <div id="tbl-TaiKhoan" class="hntbl-cover table-scroll">
            <div class="table-wrap">
                <table class="hinet-table table table-striped table-hover" cellspacing="0" width="100%">
                    <thead>
                        <tr>
                            <th class="fixed-side">#</th>
                            <th class="fixed-side">Thao tác</th>
                            <th>Mã</th>
                            <th>Trạng thái</th>
                            <th>Tên đăng nhập</th>
                            <th>Mật khẩu</th>
                            <th>Giá gốc</th>
                            <th>Giá khuyến mãi</th>
                            <th>Mô tả</th>
                            <th>Vị trí</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</div>


@section scripts{
    <script>
        //
        var multipleUploader;

        function stringToColor(str) {
            var hash = 0;
            for (var i = 0; i < str.length; i++) {
                hash = str.charCodeAt(i) + ((hash << 5) - hash);
            }
            var h = hash % 360; // Hue 0-359
            return `hsl(${h}, 60%, 50%)`; // màu dạng HSL
        }

        var lstData = eval(@lstData);
        var moduleTableSelector="#tbl-TaiKhoan";
        function pagefunction(){
            var conf=[
                {
                    tdClass:"center width50 fixed-side",
                    isSort:false,
                    nameModel: "",
                    isCounter:true,
                    content: function (data) {
                        return "<input type='checkbox' />"
                    }
                },
                   {
                       isSort:false,
                       nameModel:"",
                       tdClass:"center fixed-side",
                       content: function (data) {
                           var result = `<div class="btn-group">
                               <button data-toggle="dropdown" class="btn btn-xs btn-primary btn-white dropdown-toggle" aria-expanded="false">Thao tác<i class="ace-icon fa fa-angle-down icon-on-right"></i>
                               </button>

                               <ul class="dropdown-menu">`;
                           result += "<li><a href='javascript:void(0)' onclick='EditAction(\"/TaiKhoanArea/TaiKhoan/Edit/" + data.Id + "\")'   title = 'Chỉnh sửa'><i class='bi bi-pencil-square'> </i> Sửa thông tin</a> </li>";
                           result += "<li><a href='javascript:void(0)' onclick='DeleteAction(\"/TaiKhoanArea/TaiKhoan/Delete/" + data.Id + "\")'  title = 'Xóa'><i class=' bi bi-x-lg' style='color:red'> </i> Xóa</a></li>";
                           result += "</ul></div>";
                           return result;
                       }
                   },
				{
					isSort:true,
					nameModel:'Code',
                    content: function (data) {
                        var labels = "";
                        if (data.ListDanhMucGame && data.ListDanhMucGame.length > 0) {
                            labels = data.ListDanhMucGame.map(function (dm) {
                                var color = stringToColor(dm.Name);
                                return `<span class="badge" style="margin:2px; background-color:${color}; color:#fff;">${dm.Name}</span>`;
                            }).join(" ");
                        }

                        return `
                            <div>
                                <div><strong>${data.Code}</strong></div>
                                <div>${labels}</div>
                            </div>`;
				}
				},
				{
					isSort:true,
					nameModel:'TrangThai',
					content: function (data) {
					return data.TrangThai
				}
				},
				{
					isSort:true,
					nameModel:'UserName',
					content: function (data) {
					return data.UserName
				}
				},
				{
					isSort:true,
					nameModel:'Password',
					content: function (data) {
					return data.Password
				}
				},
				{
					isSort:true,
					nameModel:'GiaGoc',
					content: function (data) {
					return data.GiaGoc
				}
				},
				{
					isSort:true,
					nameModel:'GiaKhuyenMai',
					content: function (data) {
					return data.GiaKhuyenMai
				}
				},
				{
					isSort:true,
					nameModel:'Mota',
					content: function (data) {
					return data.Mota
				}
				},
				{
					isSort:true,
					nameModel:'ViTri',
					content: function (data) {
					return data.ViTri
				}
				},
            ];

            var getdatafunc=function(page,sortQuery,pageSize){
                $.ajax({
                    url: '/TaiKhoanArea/TaiKhoan/getData',
                    type: 'post',
                    cache: false,
                    data:{"indexPage":page,"sortQuery":sortQuery,"pageSize":pageSize},
                    success: function (data) {
                        $(moduleTableSelector).hinetTable("data",{
                            pageSize:pageSize!=-1?pageSize:data.Count,
                            pageIndex:page,
                            pagecount: data.TotalPage,
                            recordCount: data.Count,
                            listItem: data.ListItem,});
                    },
                    error: function (err) {
                        CommonJS.alert(xhr.responseText);
                    }
                });

            }

            var tblData=$("#tbl-TaiKhoan").hinetTable("init",{
                pageSizeList:{size:[20,50,100,-1],label:['20','50','100','Tất cả']},
                pagecount: @Model.TotalPage,
                recordCount: @Model.Count,
                actionToolBar:'<a href=\"#collapseDiv\" aria-controls=\"collapsePanel\" data-toggle=\"collapse\" role=\"button\" class="btn btn-primary btn-xs"><i class="fa fa-search"></i> Tìm kiếm</a>',
                getData:getdatafunc,
                listItem:lstData,
                config:conf
            });

        }

        function AfterSussessActionAjaxform(){
            $(moduleTableSelector).hinetTable("reload");
        }

        function AjaxSearchSuccess(rs) {
            $(moduleTableSelector).hinetTable("data", {
                pageIndex: 1,
                pagecount: rs.TotalPage,
                recordCount: rs.Count,
                listItem: rs.ListItem,
            });
        }
        pagefunction();
    </script>
}