@using Newtonsoft.Json;
<style>

    #map1 {
        width: 100%;
        height: @(ViewBag.height)px;

    }

    html,
    @{
        var latOld = Html.Raw(ViewBag.latOld);
        var lngOld = Html.Raw(ViewBag.lngOld);
    }
</style>

<div id="map1"></div>
<script>
    var latold = eval(@latOld);
    var lngold = eval(@lngOld);
    var clickedLat, clickedLng;
    var myLatlng = { lat: eval(@ViewBag.lat), lng: eval(@ViewBag.lng) };

    var map;
    var marker = null;
    var iconBase ="https://developers.google.com/maps/documentation/javascript/examples/full/images/";
    //Promise.all(ajaxRequests)
    //    .then(() => {
            function initMap() {
                map = new google.maps.Map(document.getElementById("map1"), {
                    center: myLatlng,
                    zoom: @ViewBag.ZoomLevel,
                    mapTypeControl: false
                });

                removeMarkers();
                IconCenter = new google.maps.Marker({
                    position: myLatlng,
                    map: map,
                    icon: {
                        url: '/Uploads/IconMarker/CenterPoint.png',
                        scaledSize: new google.maps.Size(32, 32) // Adjust the size as per your requirements
                    }
                });
                markers.push(IconCenter);

                //Create marker Center point

                //lstParth.map((x, index) => {
                //    var arrayArea = x.geojson.coordinates;
                //    var arrayList = [];
                //    arrayArea[0].forEach(y => {
                //        var point = {
                //            lat: parseFloat(y[1]),
                //            lng: parseFloat(y[0])
                //        };
                //        arrayList.push(point);
                //    });

                //    const triangleCoords = arrayList;
                //    const bermudaTriangle = new google.maps.Polygon({
                //        paths: triangleCoords,
                //        strokeColor: lstColor[index],
                //        strokeOpacity: 0.8,
                //        strokeWeight: 3,
                //        fillColor: "transparent",
                //        fillOpacity: 0.35,
                //    });

                //    bermudaTriangle.setMap(map);

                //    // Add a click event listener to the Polugon
                //    bermudaTriangle.addListener("click", (event) => {
                //        // Remove the previous marker, if it exists
                //        if (marker) {
                //            marker.setMap(null);
                //        }

                //        // Create a new marker at the clicked location
                //        marker = new google.maps.Marker({
                //            position: event.latLng,
                //            map: map,
                //        });

                //        // Retrieve the latitude and longitude coordinates
                //        const clickedLatLng = event.latLng;
                //        const clickedLat = clickedLatLng.lat();
                //        const clickedLng = clickedLatLng.lng();
                //    });

                //});

                if (latold != null && lngold != null) {
                    // Marker generated by Db
                    const uluru = { lat: latold, lng: lngold };
                    const contentString =
                        '<div id="content">' +
                        '<div id="siteNotice">' +
                        "</div>" +
                        '<h1 id="firstHeading" class="firstHeading">Điểm đã chọn</h1>' +
                        "</div>" +
                        "</div>";
                    const infowindow = new google.maps.InfoWindow({
                        content: contentString,
                        ariaLabel: "Uluru",
                    });
                    marker = new google.maps.Marker({
                        position: uluru,
                        map,
                        title: "Uluru (Ayers Rock)",
                    });

                    marker.addListener("click", () => {
                        infowindow.open({
                            anchor: marker,
                            map,
                        });
                    });
                }

                // Add a click event listener to the map
                map.addListener("click", (event) => {
                    // Remove the previous marker, if it exists
                    if (marker) {
                        marker.setMap(null);
                    }

                    // Create a new marker at the clicked location
                    marker = new google.maps.Marker({
                        position: event.latLng,
                        map: map,
                    });

                    // Retrieve the latitude and longitude coordinates
                    const clickedLatLng = event.latLng;
                    clickedLat = clickedLatLng.lat();
                    clickedLng = clickedLatLng.lng();
                    setLatLng();
                });

            }
            window.initMap = initMap;
        //})
        //.catch((error) => {
        //    console.error(error);
        //});

    var markers = [];

    // Function to remove all markers from the map
    function removeMarkers() {
        for (let i = 0; i < markers.length; i++) {
            markers[i].setMap(null);
        }
        markers.length = 0; // Clear the markers array
    }
</script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAgEUiZdXI2mRi-wE6aUroT_lPgVbnBAsc&language=vi-VN&callback=initMap&v=weekly" defer></script>